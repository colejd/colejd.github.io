{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/blog/randomizing-uicolor-with-swizzling/",
    "result": {"data":{"site":{"siteMetadata":{"title":"Jon's Website","language":"en-US","siteUrl":"https://jons.website"}},"markdownRemark":{"id":"f0c1331d-76bc-5552-ba90-03f68ab03866","excerpt":"Lately, I’ve helped contribute to [Slide for Reddit](<>), an open-source Reddit client for iOS written in Swift. We’re reconsidering some aspects of our UI…\n","html":"<p>Lately, I’ve helped contribute to <a href=\"https://github.com/ccrama/Slide-iOS\">Slide for Reddit</a>, an open-source Reddit client for iOS written in Swift. We’re reconsidering some aspects of our UI customization options, and I’m of the opinion that the user just doesn’t have the tools they need to make the app as ugly as humanly possible. As a joke, I wanted to randomize all the colors throughout the app just to see what it would look like. That led to an interesting question: is it possible to write an extension for <code>UIColor</code> that forces all instances to be randomized when they are used?</p>\n<p>This was a surprisingly deep rabbit hole to jump into.</p>\n<h2 id=\"first-steps\" style=\"position:relative;\"><a href=\"#first-steps\" aria-label=\"first steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>First Steps</h2>\n<p>It is not possible to override a property or method inside of a Swift extension. This precludes doing something fishy like overriding <code>UIColor</code>’s initializer. In any case, we want the color to change every time it is accessed, so we would need to override a property of <code>UIColor</code>.</p>\n<p>Interestingly, <code>UIColor</code>s are not used directly for drawing; instead, they serve a <code>CGColor</code> instance via their <code>cgColor</code> property when accessed. If we could override <code>cgColor</code> in our extension, we could return a random color from there, but this is not allowed. Or at least, it isn’t allowed in pure Swift.</p>\n<p>The Objective-C runtime allows us to perform <em>method swizzling</em>, which is a technique that replaces the implementation of a selector with another implementation at run time. After a brief read on this topic, I had the following code:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">extension</span> <span class=\"token class-name\">UIColor</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">class</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">jc_swizzle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> originalSelector <span class=\"token operator\">=</span> <span class=\"token other-directive property\">#selector</span><span class=\"token punctuation\">(</span>getter<span class=\"token punctuation\">:</span> cgColor<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">let</span> swizzledSelector <span class=\"token operator\">=</span> <span class=\"token other-directive property\">#selector</span><span class=\"token punctuation\">(</span>randomCGColor<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">let</span> originalMethod <span class=\"token operator\">=</span> <span class=\"token function\">class_getInstanceMethod</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> originalSelector<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span>\n    <span class=\"token keyword\">let</span> swizzledMethod <span class=\"token operator\">=</span> <span class=\"token function\">class_getInstanceMethod</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> swizzledSelector<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span>\n    <span class=\"token function\">method_exchangeImplementations</span><span class=\"token punctuation\">(</span>originalMethod<span class=\"token punctuation\">,</span> swizzledMethod<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token attribute atrule\">@objc</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">randomCGColor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">CGColor</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">CGColor</span><span class=\"token punctuation\">(</span>\n      colorSpace<span class=\"token punctuation\">:</span> <span class=\"token class-name\">CGColorSpaceCreateDeviceRGB</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      components<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token class-name\">CGFloat</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Float</span><span class=\"token punctuation\">(</span><span class=\"token function\">arc4random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token class-name\">Float</span><span class=\"token punctuation\">(</span>UINT32_MAX<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// R</span>\n        <span class=\"token class-name\">CGFloat</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Float</span><span class=\"token punctuation\">(</span><span class=\"token function\">arc4random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token class-name\">Float</span><span class=\"token punctuation\">(</span>UINT32_MAX<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// G</span>\n        <span class=\"token class-name\">CGFloat</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Float</span><span class=\"token punctuation\">(</span><span class=\"token function\">arc4random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token class-name\">Float</span><span class=\"token punctuation\">(</span>UINT32_MAX<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// B</span>\n        <span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// A</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!</span>\n  <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>In <code>jc_swizzle()</code>, we swap the getter for <code>UIColor.cgColor</code> with the extension function <code>randomCGColor()</code>. This in theory does what we want! Let’s see what it looks like:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; max-width: clamp(200px, calc(0.46210720887245843* 80vh), 462.1px); max-height: 1000px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/174a74a387ad857489e9bf17df33882f/78797/stage1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 216.39999999999998%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Slide looking perfectly normal.\"\n        title=\"Slide looking perfectly normal.\"\n        src=\"/static/174a74a387ad857489e9bf17df33882f/00d43/stage1.png\"\n        srcset=\"/static/174a74a387ad857489e9bf17df33882f/63868/stage1.png 250w,\n/static/174a74a387ad857489e9bf17df33882f/0b533/stage1.png 500w,\n/static/174a74a387ad857489e9bf17df33882f/00d43/stage1.png 1000w,\n/static/174a74a387ad857489e9bf17df33882f/78797/stage1.png 1125w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>What?! That looks good! That can’t be right. What happened?</p>\n<h2 id=\"class-clusters\" style=\"position:relative;\"><a href=\"#class-clusters\" aria-label=\"class clusters permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Class Clusters</h2>\n<p>As it turns out, Apple makes use of an Objective-C pattern called a <em><a href=\"https://developer.apple.com/library/archive/documentation/General/Conceptual/CocoaEncyclopedia/ClassClusters/ClassClusters.html\">class cluster</a></em> in <code>UIColor</code>. Under the hood, there are many private subclasses of <code>UIColor</code>, but they’re all hidden from any public interface. That means we just overrode the method of a class that doesn’t actually ever get used.</p>\n<p>So then, let’s find out what class some random <code>UIColor</code> instance resolves to. For <code>UIColor.red</code>, that ends up being <code>UICachedDeviceRGBColor</code>. Let’s work on that:</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">extension</span> <span class=\"token class-name\">UIColor</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">jc_swizzle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// This resolves to `UICachedDeviceRGBColor`</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">let</span> _class<span class=\"token punctuation\">:</span> <span class=\"token class-name\">AnyClass</span><span class=\"token operator\">!</span> <span class=\"token operator\">=</span> <span class=\"token function\">object_getClass</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">UIColor</span><span class=\"token punctuation\">.</span>red<span class=\"token punctuation\">)</span></span>\n    <span class=\"token keyword\">let</span> originalMethod <span class=\"token operator\">=</span> <span class=\"token function\">class_getInstanceMethod</span><span class=\"token punctuation\">(</span>_class<span class=\"token punctuation\">,</span> <span class=\"token other-directive property\">#selector</span><span class=\"token punctuation\">(</span>getter<span class=\"token punctuation\">:</span> cgColor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">let</span> swizzledMethod <span class=\"token operator\">=</span> <span class=\"token function\">class_getInstanceMethod</span><span class=\"token punctuation\">(</span>_class<span class=\"token punctuation\">,</span> <span class=\"token other-directive property\">#selector</span><span class=\"token punctuation\">(</span>randomCGColor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> originalMethod <span class=\"token operator\">=</span> originalMethod<span class=\"token punctuation\">,</span> <span class=\"token keyword\">let</span> swizzledMethod <span class=\"token operator\">=</span> swizzledMethod <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">method_exchangeImplementations</span><span class=\"token punctuation\">(</span>originalMethod<span class=\"token punctuation\">,</span> swizzledMethod<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">dynamic</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">randomCGColor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">CGColor</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">CGColor</span><span class=\"token punctuation\">(</span>colorSpace<span class=\"token punctuation\">:</span> <span class=\"token class-name\">CGColorSpaceCreateDeviceRGB</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> components<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token class-name\">CGFloat</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Float</span><span class=\"token punctuation\">(</span><span class=\"token function\">arc4random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token class-name\">Float</span><span class=\"token punctuation\">(</span>UINT32_MAX<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// R</span>\n      <span class=\"token class-name\">CGFloat</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Float</span><span class=\"token punctuation\">(</span><span class=\"token function\">arc4random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token class-name\">Float</span><span class=\"token punctuation\">(</span>UINT32_MAX<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// G</span>\n      <span class=\"token class-name\">CGFloat</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Float</span><span class=\"token punctuation\">(</span><span class=\"token function\">arc4random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token class-name\">Float</span><span class=\"token punctuation\">(</span>UINT32_MAX<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// B</span>\n      <span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// A</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!</span>\n  <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; max-width: clamp(200px, calc(0.46210720887245843* 80vh), 462.1px); max-height: 1000px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/51023eb02737342fe2529f68c4d3fd6f/78797/stage2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 216.39999999999998%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Slide with mostly randomized colors.\"\n        title=\"Slide with mostly randomized colors.\"\n        src=\"/static/51023eb02737342fe2529f68c4d3fd6f/00d43/stage2.png\"\n        srcset=\"/static/51023eb02737342fe2529f68c4d3fd6f/63868/stage2.png 250w,\n/static/51023eb02737342fe2529f68c4d3fd6f/0b533/stage2.png 500w,\n/static/51023eb02737342fe2529f68c4d3fd6f/00d43/stage2.png 1000w,\n/static/51023eb02737342fe2529f68c4d3fd6f/78797/stage2.png 1125w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>This works. On the highlighted line, we get the class object for <code>UIColor.red</code> (<code>UICachedDeviceRGBColor</code>), which we then pass as the first argument to <code>class_getInstanceMethod</code> instead of <code>UIColor.self</code>. By swizzling <code>UICachedDeviceRGBColor</code> we can affect many, many more colors.</p>\n<p>But who knows how many other <code>UIColor</code> subclasses there are? I couldn’t stop here. I wanted to ruin <em>all</em> the colors. The code that results from this path of inquiry is horrible and evil and will absolutely get you rejected from the App Store. Apple doesn’t like developers referencing private headers, after all. Let’s do it anyway.</p>\n<p>How can we reference the private internal objc classes that back <code>UIColor</code>? Well, we can use <code>NSClassFromString()</code> to get them if we know their names. We know about <code>UICachedDeviceWhiteColor</code> and <code>UICachedDeviceRGBColor</code> but who knows how many others there are under the hood?</p>\n<p>Well, I knows. The answer is ten:</p>\n<ul class=\"bullet-list\">\n<li><code>UIDeviceRGBColor</code></li>\n<li><code>UICachedDeviceRGBColor</code> (derives from <code>UIDeviceRGBColor</code>)</li>\n<li><code>NSColor</code></li>\n<li><code>UIDisplayP3Color</code></li>\n<li><code>UIPlaceholderColor</code></li>\n<li><code>UICIColor</code></li>\n<li><code>UIDeviceWhiteColor</code></li>\n<li><code>UICachedDeviceWhiteColor</code> (derives from <code>UIDeviceWhiteColor</code>)</li>\n<li><code>UICGColor</code></li>\n<li><code>UICachedDevicePatternColor</code> (derives from <code>UICGColor</code>)</li>\n</ul>\n<p>I found these by grepping through <a href=\"https://github.com/nst/iOS-Runtime-Headers\">a dump of the private headers in iOS 11.4</a>. If you’d like to do this yourself, run <code>grep -r -n \".\\+:\\s*UIColor\".</code> in the terminal (you’ll also want to run this again for each subclass you discover, replacing <code>UIColor</code> with the new class name just in case there are any subclasses of those). Let’s use these:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">extension</span> <span class=\"token class-name\">UIColor</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">StaticVars</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Names of classes to swizzle. Derived from dumped private headers.</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">let</span> classesToSwizzle<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token string-literal\"><span class=\"token string\">\"UIColor\"</span></span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-literal\"><span class=\"token string\">\"UIDeviceRGBColor\"</span></span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-literal\"><span class=\"token string\">\"NSColor\"</span></span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-literal\"><span class=\"token string\">\"UIDisplayP3Color\"</span></span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-literal\"><span class=\"token string\">\"UIPlaceholderColor\"</span></span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-literal\"><span class=\"token string\">\"UICIColor\"</span></span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-literal\"><span class=\"token string\">\"UIDeviceWhiteColor\"</span></span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-literal\"><span class=\"token string\">\"UICGColor\"</span></span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-literal\"><span class=\"token string\">\"UICachedDeviceRGBColor\"</span></span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-literal\"><span class=\"token string\">\"UICachedDeviceWhiteColor\"</span></span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-literal\"><span class=\"token string\">\"UICachedDevicePatternColor\"</span></span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span>\n\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">let</span> randomColorBlock<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@convention</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">AnyObject</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">CGColor</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token omit keyword\">_</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">CGColor</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span>\n      <span class=\"token keyword\">return</span> <span class=\"token class-name\">CGColor</span><span class=\"token punctuation\">(</span>colorSpace<span class=\"token punctuation\">:</span> <span class=\"token class-name\">CGColorSpaceCreateDeviceRGB</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> components<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token class-name\">CGFloat</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Float</span><span class=\"token punctuation\">(</span><span class=\"token function\">arc4random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token class-name\">Float</span><span class=\"token punctuation\">(</span>UINT32_MAX<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// R</span>\n        <span class=\"token class-name\">CGFloat</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Float</span><span class=\"token punctuation\">(</span><span class=\"token function\">arc4random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token class-name\">Float</span><span class=\"token punctuation\">(</span>UINT32_MAX<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// G</span>\n        <span class=\"token class-name\">CGFloat</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Float</span><span class=\"token punctuation\">(</span><span class=\"token function\">arc4random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token class-name\">Float</span><span class=\"token punctuation\">(</span>UINT32_MAX<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// B</span>\n        <span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// A</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">jc_swizzle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">for</span> className <span class=\"token keyword\">in</span> <span class=\"token class-name\">StaticVars</span><span class=\"token punctuation\">.</span>classesToSwizzle <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> classFromString <span class=\"token operator\">=</span> <span class=\"token class-name\">NSClassFromString</span><span class=\"token punctuation\">(</span>className<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">let</span> originalMethod <span class=\"token operator\">=</span> <span class=\"token function\">class_getInstanceMethod</span><span class=\"token punctuation\">(</span>classFromString<span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> <span class=\"token other-directive property\">#selector</span><span class=\"token punctuation\">(</span>getter<span class=\"token punctuation\">:</span> cgColor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">method_setImplementation</span><span class=\"token punctuation\">(</span>originalMethod<span class=\"token punctuation\">,</span> <span class=\"token function\">imp_implementationWithBlock</span><span class=\"token punctuation\">(</span>\n          <span class=\"token function\">unsafeBitCast</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StaticVars</span><span class=\"token punctuation\">.</span>randomColorBlock<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">:</span> <span class=\"token class-name\">AnyObject</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This is much, <em>much</em> more effective:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; max-width: clamp(200px, calc(0.46210720887245843* 80vh), 462.1px); max-height: 1000px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3f17c602efdb35d67aae4df67375c418/78797/stage3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 216.39999999999998%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Slide with fully randomized colors.\"\n        title=\"Slide with fully randomized colors.\"\n        src=\"/static/3f17c602efdb35d67aae4df67375c418/00d43/stage3.png\"\n        srcset=\"/static/3f17c602efdb35d67aae4df67375c418/63868/stage3.png 250w,\n/static/3f17c602efdb35d67aae4df67375c418/0b533/stage3.png 500w,\n/static/3f17c602efdb35d67aae4df67375c418/00d43/stage3.png 1000w,\n/static/3f17c602efdb35d67aae4df67375c418/78797/stage3.png 1125w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Note how everything is affected, including the individual drawable elements in the status bar:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; max-width: clamp(200px, calc(8.333333333333334* 80vh), 1000px); max-height: 1000px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/43b8a4475ff241c4ef82421932919f9f/78797/stage3-toolbar.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 12%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAV0lEQVQI15XMMQ6AIBAFUW4BrLqAibEwodAYXBbvf6yvnMBYTDHNM84WzCQ4Y8M6VvQnd31nC7yvSFPDwYLMiuAKTAcSCfagWAb5BZJXRL6RuWJjBb/gA/T0OXal79/JAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"A close-up of the system toolbar with mostly randomized colors.\"\n        title=\"A close-up of the system toolbar with mostly randomized colors.\"\n        src=\"/static/43b8a4475ff241c4ef82421932919f9f/00d43/stage3-toolbar.png\"\n        srcset=\"/static/43b8a4475ff241c4ef82421932919f9f/63868/stage3-toolbar.png 250w,\n/static/43b8a4475ff241c4ef82421932919f9f/0b533/stage3-toolbar.png 500w,\n/static/43b8a4475ff241c4ef82421932919f9f/00d43/stage3-toolbar.png 1000w,\n/static/43b8a4475ff241c4ef82421932919f9f/78797/stage3-toolbar.png 1125w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>This is a fine solution, but it doesn’t satisfy the engineer in me. What happens when iOS updates? What if there are classes that I missed?</p>\n<h2 id=\"things-get-worse\" style=\"position:relative;\"><a href=\"#things-get-worse\" aria-label=\"things get worse permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Things Get Worse</h2>\n<p>Shortly after writing this code, I was made aware of <code>objc_getClassList()</code>. This creates a list of class objects for <em>every single</em> class loaded at runtime. In fact, on my phone running iOS 11.3.1, that list contains 25,265 elements. Let’s parse these instead of keeping a list of strings:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">extension</span> <span class=\"token class-name\">UIColor</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">StaticVars</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">let</span> randomColorBlock<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@convention</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">AnyObject</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">CGColor</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token omit keyword\">_</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">CGColor</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span>\n      <span class=\"token keyword\">return</span> <span class=\"token class-name\">CGColor</span><span class=\"token punctuation\">(</span>colorSpace<span class=\"token punctuation\">:</span> <span class=\"token class-name\">CGColorSpaceCreateDeviceRGB</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> components<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token class-name\">CGFloat</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Float</span><span class=\"token punctuation\">(</span><span class=\"token function\">arc4random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token class-name\">Float</span><span class=\"token punctuation\">(</span>UINT32_MAX<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// R</span>\n        <span class=\"token class-name\">CGFloat</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Float</span><span class=\"token punctuation\">(</span><span class=\"token function\">arc4random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token class-name\">Float</span><span class=\"token punctuation\">(</span>UINT32_MAX<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// G</span>\n        <span class=\"token class-name\">CGFloat</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Float</span><span class=\"token punctuation\">(</span><span class=\"token function\">arc4random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token class-name\">Float</span><span class=\"token punctuation\">(</span>UINT32_MAX<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// B</span>\n        <span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// A</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">jc_swizzle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">// Returns true if the given class has `superclass` anywhere in its class hierarchy</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">isClassSubclassOf</span><span class=\"token punctuation\">(</span><span class=\"token omit keyword\">_</span> base<span class=\"token punctuation\">:</span> <span class=\"token class-name\">AnyClass</span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> superclass<span class=\"token punctuation\">:</span> <span class=\"token class-name\">AnyClass</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Bool</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">var</span> _class<span class=\"token punctuation\">:</span> <span class=\"token class-name\">AnyClass</span><span class=\"token operator\">?</span> <span class=\"token operator\">=</span> base\n        <span class=\"token keyword\">while</span> _class <span class=\"token operator\">!=</span> <span class=\"token nil constant\">nil</span> <span class=\"token operator\">&amp;&amp;</span> _class <span class=\"token operator\">!=</span> superclass <span class=\"token punctuation\">{</span>\n            _class <span class=\"token operator\">=</span> <span class=\"token function\">class_getSuperclass</span><span class=\"token punctuation\">(</span>_class<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> _class <span class=\"token operator\">==</span> superclass\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">var</span> classCount <span class=\"token operator\">=</span> <span class=\"token function\">objc_getClassList</span><span class=\"token punctuation\">(</span><span class=\"token nil constant\">nil</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">var</span> allClasses <span class=\"token operator\">=</span> <span class=\"token class-name\">UnsafeMutablePointer</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">AnyClass</span><span class=\"token operator\">?></span><span class=\"token punctuation\">.</span><span class=\"token function\">allocate</span><span class=\"token punctuation\">(</span>capacity<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Int</span><span class=\"token punctuation\">(</span>classCount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">var</span> autoreleasingAllClasses <span class=\"token operator\">=</span> <span class=\"token class-name\">AutoreleasingUnsafeMutablePointer</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">AnyClass</span><span class=\"token operator\">?></span><span class=\"token punctuation\">(</span>allClasses<span class=\"token punctuation\">)</span>\n    classCount <span class=\"token operator\">=</span> <span class=\"token function\">objc_getClassList</span><span class=\"token punctuation\">(</span>autoreleasingAllClasses<span class=\"token punctuation\">,</span> classCount<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token number\">0</span> <span class=\"token operator\">..&lt;</span> classCount <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> currentClass<span class=\"token punctuation\">:</span> <span class=\"token class-name\">AnyClass</span> <span class=\"token operator\">=</span> allClasses<span class=\"token punctuation\">[</span><span class=\"token class-name\">Int</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token function\">isClassSubclassOf</span><span class=\"token punctuation\">(</span>currentClass<span class=\"token punctuation\">,</span> superclass<span class=\"token punctuation\">:</span> <span class=\"token class-name\">UIColor</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">let</span> originalMethod <span class=\"token operator\">=</span> <span class=\"token function\">class_getInstanceMethod</span><span class=\"token punctuation\">(</span>currentClass<span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> <span class=\"token other-directive property\">#selector</span><span class=\"token punctuation\">(</span>getter<span class=\"token punctuation\">:</span> cgColor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">method_setImplementation</span><span class=\"token punctuation\">(</span>originalMethod<span class=\"token punctuation\">,</span> <span class=\"token function\">imp_implementationWithBlock</span><span class=\"token punctuation\">(</span>\n          <span class=\"token function\">unsafeBitCast</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StaticVars</span><span class=\"token punctuation\">.</span>randomColorBlock<span class=\"token punctuation\">,</span> to<span class=\"token punctuation\">:</span> <span class=\"token class-name\">AnyObject</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n  <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Here we use <code>objc_getClassList</code> to look through <em>every single class</em> registered at runtime, swizzling the ones that derive from <code>UIColor</code>. This has two benefits. Firstly, because we’re not directly referencing any private derivatives of <code>UIColor</code>, we’re probably <em>(probably)</em> not going to get rejected from the App Store for using this code. Secondly it is better from the standpoint that it will be resistant to changes in iOS in the future. This is guaranteed to replace all <code>UIColor</code> instance getters with the new random color logic, satisfying my original goal.</p>\n<p>With that, we have an answer to <em>“Can I?”</em> Perhaps the next article should go into <em>“Should I?”</em></p>","fields":{"slug":"/blog/randomizing-uicolor-with-swizzling/"},"frontmatter":{"title":"Randomizing UIColor with Method Swizzling","subtitle":"Why not?","coverPhoto":{"publicURL":"/static/ed27f254c254d4121d84824de84f12a9/preview-small.png","childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAACsElEQVQoz1XGe0zMAQDA8R//xD8286hpVpv5yyZdV3QOc9puWJYpl0r0uFII1R3pltJDm0oXkvSSy0XKa3PVEllbd+pK5TItflLn1Ys8Nq99rZjxx2ffr6AYlLJn70Y21a9l5Td35O89WD0pQT7pgWzcA89Rd9aMSlk/shrvETneU30n//NyZNMvQznhg8+kEiHAcIWdldUkmiqJqK1CdbGKYMNVtlZUEd5zhZzBRlS2Inwu1qMu7CT6vJXo4odEF1mJKuokuthMZFE/rrEFLNwajJCYV8rBwhJijCUczjagSTeQlFGNOvUCxrZmsNox9NUhOX4PReIYCu0bFEeG2KB9heKwnQ1JIuuOfELi5s8WJwFhXt92HF6omDkciIMYyCxxB7PFIGY890c6pEH1OJtt/cm4pNoQDoCQ8BUhjt8/ZeoPwZxd7SwNqUUIuhWJzKrGu1fNqt4oVj1WT/O2ReL+KIpltv0o22LYfaqWdfntbNabkGf2IzshIst6jixTRJbxjBXZdlbkjiNo/Wwk+9rQ+XWj29ZFsm8vR3270SlFkkNvE+ofT7q2mDrLSUo6UijtyKC88xgV1hTKu1Motem49CSN1h491xs0CMGudkJcX7HL5TXhLiOEOY8R7jxK6Nwv5MU9ZK92EwcjUzH3VNIo5tE0UEBDv576p3oaRT1N9jzaRs9RVrcfZYAE4cy+b+TGfSQn9if6PZAfA/oYyI+Cs7oPZCVZSEu4y7OBa/Cjhc/fG4Bm4D5w748H9Inl3GjJQmgIKqA0PIvKwNPUqCq4qir7q8a/gjq/Gm6EFWLOjqA9PYHGsxEMXI5n2KjlpVHDkFEz3be1OiZupiFYvJwwr1xCl+cCOrzmY/1Hs9dCTF4LMEkdMXks5o7UmWbJYixuTpjdHP/T6raI1uWO/AIONwkCDHgm1wAAAABJRU5ErkJggg=="},"images":{"fallback":{"src":"/static/ed27f254c254d4121d84824de84f12a9/633af/preview-small.png","srcSet":"/static/ed27f254c254d4121d84824de84f12a9/189e1/preview-small.png 281w,\n/static/ed27f254c254d4121d84824de84f12a9/f12ce/preview-small.png 563w,\n/static/ed27f254c254d4121d84824de84f12a9/633af/preview-small.png 1125w","sizes":"(min-width: 1125px) 1125px, 100vw"},"sources":[{"srcSet":"/static/ed27f254c254d4121d84824de84f12a9/7d3d0/preview-small.avif 281w,\n/static/ed27f254c254d4121d84824de84f12a9/91e00/preview-small.avif 563w,\n/static/ed27f254c254d4121d84824de84f12a9/23f82/preview-small.avif 1125w","type":"image/avif","sizes":"(min-width: 1125px) 1125px, 100vw"},{"srcSet":"/static/ed27f254c254d4121d84824de84f12a9/df2be/preview-small.webp 281w,\n/static/ed27f254c254d4121d84824de84f12a9/b4525/preview-small.webp 563w,\n/static/ed27f254c254d4121d84824de84f12a9/b37fe/preview-small.webp 1125w","type":"image/webp","sizes":"(min-width: 1125px) 1125px, 100vw"}]},"width":1125,"height":563}}},"coverPhotoAlt":"A screenshot of Slide for Reddit with all colors randomized","date":"2018-08-10T00:00:00.000Z","isoDate":"2018-08-10","readableDate":"August 10th, 2018","dateModified":null,"description":"Breaking UIKit with code injection.","keywords":"ios uicolor random swizzling swift objective-c hack software programming development"}}},"pageContext":{"slug":"/blog/randomizing-uicolor-with-swizzling/","previous":{"fields":{"slug":"/blog/spurious-spatial-correlations/"},"frontmatter":{"template":"blog-post","title":"Spurious (Spatial) Correlations","draft":null}},"next":{"fields":{"slug":"/blog/opencv-tip-arrays/"},"frontmatter":{"template":"blog-post","title":"OpenCV, InputArray, OutputArray, and You","draft":null}}}},
    "staticQueryHashes": ["2780354278","3903778693"]}