{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/blog/opencv-tip-arrays/",
    "result": {"data":{"site":{"siteMetadata":{"title":"Jon's Website","language":"en-US","siteUrl":"https://jons.website"}},"markdownRemark":{"id":"73918137-6077-5859-b5ad-c1a705da960f","excerpt":"When you’re writing OpenCV code in C++, you’ll eventually want to pass whatever `Mat` objects you have into a function or a class method. For the purposes of this…\n","html":"<p>When you’re writing OpenCV code in C++, you’ll eventually want to pass whatever <code>Mat</code> objects you have into a function or a class method. For the purposes of this post, let’s say we want to write a utility function that prepares a BGR888 <code>Mat</code> for edge detection. This typically involves converting the image to grayscale, as well as blurring it to remove superficial details.</p>\n<p>It’s tempting to write the following function signature:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// Revision 1</span>\nMat <span class=\"token function\">preprocess</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> Mat<span class=\"token operator\">&amp;</span> input<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  Mat gray<span class=\"token punctuation\">,</span> output<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">cvtColor</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">,</span> gray<span class=\"token punctuation\">,</span> COLOR_BGR2GRAY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">blur</span><span class=\"token punctuation\">(</span>gray<span class=\"token punctuation\">,</span> output<span class=\"token punctuation\">,</span> <span class=\"token function\">Size</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> output<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This is good C++ code; we pass a reference to the input <code>Mat</code> so that we don’t incur a copy, and we use <code>const</code> to mark the reference as read-only. However, OpenCV provides some utilities that we can use to improve this function.</p>\n<p><code>Mat</code> is not the only container for representing an image in OpenCV. If you’re looking to leverage OpenCV’s <a href=\"https://www.learnopencv.com/opencv-transparent-api/\">Transparent API</a> for GPU acceleration, you’ll want to use <code>UMat</code> as your container instead. If you have an existing codebase full of utility functions written like above, you’re going to have to make copies that take a <code>UMat</code> reference if you want to use those.</p>\n<p>Fortunately, OpenCV has a solution to this problem in the form of the <a href=\"https://docs.opencv.org/4.0.1/d4/d32/classcv_1_1__InputArray.html#details\"><code>InputArray</code></a> proxy class. As per the docs, <code>InputArray</code> lets you pass in a <code>Mat</code>, <code>UMat</code>, or even a <code>std::vector</code>, among others.</p>\n<p>Here’s what our function looks like using <code>InputArray</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// Revision 2</span>\nMat <span class=\"token function\">preprocess</span><span class=\"token punctuation\">(</span>InputArray input<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  Mat gray<span class=\"token punctuation\">,</span> output<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">cvtColor</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">,</span> gray<span class=\"token punctuation\">,</span> COLOR_BGR2GRAY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">blur</span><span class=\"token punctuation\">(</span>gray<span class=\"token punctuation\">,</span> output<span class=\"token punctuation\">,</span> <span class=\"token function\">Size</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> output<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Note that we aren’t passing a reference to <code>input</code>. <code>InputArray</code> internally typedefs as a reference, so that’s taken care of for you; that said, <code>Mat</code> and <code>UMat</code> are internally backed by smart pointers, so we don’t need to worry about getting a reference anyway! Using <code>InputArray</code> also has the nice benefit of making your image read-only as far as the OpenCV SDK is concerned, which helps the compiler find issues and makes your code easier to read.</p>\n<p>OpenCV provides a similar proxy class called <a href=\"https://docs.opencv.org/4.0.1/d2/d9e/classcv_1_1__OutputArray.html#details\"><code>OutputArray</code></a>, which wraps the same types but is treated as write-only. Let’s rewrite <code>preprocess()</code> with that:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// Revision 3</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">preprocess</span><span class=\"token punctuation\">(</span>InputArray input<span class=\"token punctuation\">,</span> OutputArray output<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  Mat gray<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">cvtColor</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">,</span> gray<span class=\"token punctuation\">,</span> COLOR_BGR2GRAY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">blur</span><span class=\"token punctuation\">(</span>gray<span class=\"token punctuation\">,</span> output<span class=\"token punctuation\">,</span> <span class=\"token function\">Size</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now instead of returning a new <code>Mat</code> object, whatever we pass into <code>output</code> will be written to.</p>\n<p>Why would we want to do this? Well, when you’re writing computer vision code, you need to be careful about how your image data is being passed around. After all, the images you’re passing around are uncompressed; a 4000x4000 image in BGR888 format would take around 48 megabytes of space in RAM. That’s not a lot, but it adds up fast, particularly if you’re parallelizing or running on a mobile platform. If we gave that image to Revision 2 of the <code>preprocess()</code> function, we would be allocating two copies of the image; one temporary (<code>gray</code>) and one that we keep and return ( <code>output</code>).</p>\n<p>With Revision 3, we’ve moved the decision to allocate the output from inside of the function to wherever it gets called. If you want a copy, call <code>preprocess(someMat, someOtherMat)</code>. If you want to overwrite the original <code>Mat</code>, just call <code>preprocess(someMat, someMat)</code>, using the same object for the input and the output. If you’ve wondered why so many of OpenCV’s functions write outputs to an <code>OutputArray</code> parameter instead of returning a <code>Mat</code>, this is why!</p>\n<p>Now let’s say we <em>always</em> want <code>preprocess()</code> to operate in-place. We can make use of OpenCV’s <code>InputOutputArray</code> to completely avoid allocating new images in <code>preprocess()</code> and make the function a little easier to read:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// Revision 4</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">preprocess</span><span class=\"token punctuation\">(</span>InputOutputArray input<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">cvtColor</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">,</span> input<span class=\"token punctuation\">,</span> COLOR_BGR2GRAY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">blur</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">,</span> input<span class=\"token punctuation\">,</span> <span class=\"token function\">Size</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Easy.</p>\n<p>As a footnote, you might be wondering to yourself, “Why not just avoid all of this and use <code>UMat</code> everywhere?” The simple answer is that OpenCV functions that consume a <code>UMat</code> will run on the GPU if it can, falling back on the CPU if not. If you pass a <code>Mat</code>, it will always run on the CPU. Sometimes you’ll want to explicitly force an algorithm to run on the CPU (or bail on using <code>UMat</code> when you run into some platform-specific bug), so having the ability to quickly switch between the two will save you a lot of time.</p>\n<h2 id=\"optional-outputs-with-inputarray-and-outputarray\" style=\"position:relative;\"><a href=\"#optional-outputs-with-inputarray-and-outputarray\" aria-label=\"optional outputs with inputarray and outputarray permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Optional outputs with <code>InputArray</code> and <code>OutputArray</code></h2>\n<p>A nice trick you can do with <code>InputArray</code> is making parameters optional. Let’s suppose we want to write a function that takes a <code>Mat</code> and a mask (also a <code>Mat</code>):</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">void</span> <span class=\"token function\">someFunction</span><span class=\"token punctuation\">(</span>InputArray input<span class=\"token punctuation\">,</span>\n        OutputArray output<span class=\"token punctuation\">,</span>\n        InputArray mask<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 1. Use the mask on the input</span>\n  <span class=\"token comment\">// 2. Write something into the output</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Masks in OpenCV’s own functions are typically optional; that is, you can pass in <code>noArray()</code> and no masking operation will take place. We can do that in our function as well:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">void</span> <span class=\"token function\">someFunction</span><span class=\"token punctuation\">(</span>InputArray input<span class=\"token punctuation\">,</span>\n        OutputArray output<span class=\"token punctuation\">,</span>\n        InputArray mask <span class=\"token operator\">=</span> <span class=\"token function\">noArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mask<span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 1. Use the mask on the input</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// 2. Write something into the output</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This is a trivial detail, but writing the function this way makes it so that if you don’t want a mask, you can just omit the parameter entirely instead of writing in <code>noArray()</code> yourself.</p>\n<p>A more interesting case is the ability to make an <code>OutputArray</code> optional. Let’s suppose we’re writing a function that tells us how many closed edges it could find in an image (and for good measure, let’s use Revision 3 of the <code>preprocess</code> function we wrote earlier):</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">int</span> <span class=\"token function\">getNumberOfClosedEdges</span><span class=\"token punctuation\">(</span>InputArray input<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  Mat processed<span class=\"token punctuation\">,</span> edges<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">preprocess</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">,</span> processed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">Canny</span><span class=\"token punctuation\">(</span>processed<span class=\"token punctuation\">,</span> edges<span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token number\">170</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// Imaginary function that returns the number</span>\n  <span class=\"token comment\">// of closed edges in `edges`</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">numberOfClosedEdges</span><span class=\"token punctuation\">(</span>edges<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>All we care about when we’re using this function is the number of closed edges. However, you can use the result of the Canny edge detection (<code>edges</code>) for visualization purposes or other processing tasks later on, so wouldn’t it be nice if we could optionally choose to keep it?</p>\n<p><code>OutputArray</code> has a read-only <code>needed()</code> property, which returns <code>false</code> if its backing object is a <code>noArray()</code> instance. Let’s use that with our function:</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">int</span> <span class=\"token function\">getNumberOfClosedEdges</span><span class=\"token punctuation\">(</span>InputArray input<span class=\"token punctuation\">,</span>\n        OutputArray outputEdges <span class=\"token operator\">=</span> <span class=\"token function\">noArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  Mat processed<span class=\"token punctuation\">,</span> edges<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">preprocess</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">,</span> processed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">Canny</span><span class=\"token punctuation\">(</span>processed<span class=\"token punctuation\">,</span> edges<span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token number\">170</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>outputEdges<span class=\"token punctuation\">.</span><span class=\"token function\">needed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    edges<span class=\"token punctuation\">.</span><span class=\"token function\">copyTo</span><span class=\"token punctuation\">(</span>outputEdges<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// Imaginary function that returns the number</span>\n  <span class=\"token comment\">// of closed edges in `edges`</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">numberOfClosedEdges</span><span class=\"token punctuation\">(</span>edges<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now we have an optional parameter to write the Canny results into if we want them. This technique is particularly useful for cases where you have an image processing pipeline with several steps and you want to store intermediates for visualization or debugging.</p>\n<h2 id=\"links\" style=\"position:relative;\"><a href=\"#links\" aria-label=\"links permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Links</h2>\n<ul class=\"bullet-list\">\n<li><a href=\"https://github.com/opencv/opencv/wiki/Coding_Style_Guide\">Coding Style Guide · opencv/opencv Wiki · GitHub</a></li>\n<li><a href=\"https://docs.opencv.org/4.0.1/d4/d32/classcv_1_1__InputArray.html#details\">InputArray - OpenCV Docs</a></li>\n<li><a href=\"https://docs.opencv.org/4.0.1/d2/d9e/classcv_1_1__OutputArray.html#details\">OutputArray - OpenCV Docs</a></li>\n</ul>","fields":{"slug":"/blog/opencv-tip-arrays/"},"frontmatter":{"title":"OpenCV, InputArray, OutputArray, and You","subtitle":"Improve your code with *one easy trick!*","coverPhoto":null,"coverPhotoAlt":null,"date":"2019-03-13T00:00:00.000Z","isoDate":"2019-03-13","readableDate":"March 13th, 2019","dateModified":null,"description":"Improve your code with *one easy trick!*","keywords":"opencv inputarray outputarray c++ tip software programming development"}}},"pageContext":{"slug":"/blog/opencv-tip-arrays/","previous":{"fields":{"slug":"/blog/randomizing-uicolor-with-swizzling/"},"frontmatter":{"template":"blog-post","title":"Randomizing UIColor with Method Swizzling","draft":null}},"next":{"fields":{"slug":"/blog/why-xcframeworks-matter/"},"frontmatter":{"template":"blog-post","title":"Why XCFrameworks Matter","draft":null}}}},
    "staticQueryHashes": ["2780354278","3903778693"]}